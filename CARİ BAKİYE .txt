

CREATE VIEW [dbo].[TLS_XXX_TAHSILAT] AS
SELECT 
CLC.CODE [CH KODU],
CLC.DEFINITION_ [CH ÜNVANI], 

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=0 AND PAY.PAID=0 AND PAY.TRCURR IN (0,160)),0) [TL_BAKİYE_BORÇ],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=0 AND PAY.PAID=0 AND PAY.TRCURR=1),0) [USD_BAKİYE_BORÇ],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=0 AND PAY.PAID=0 AND PAY.TRCURR=20),0) [EUR_BAKİYE_BORÇ] ,

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=1 AND PAY.PAID=0 AND PAY.TRCURR IN (0,160)),0) [TL_BAKİYE_ALACAK],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=1 AND PAY.PAID=0 AND PAY.TRCURR=1),0) [USD_BAKİYE_ALACAK],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=1 AND PAY.PAID=0 AND PAY.TRCURR=20),0) [EUR_BAKİYE_ALACAK],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=0 AND PAY.PAID=0 AND PAY.TRCURR IN (0,160)),0)- ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=1 AND PAY.PAID=0 AND PAY.TRCURR IN (0,160)),0) [KALAN_TL_BAKİYE],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=0 AND PAY.PAID=0 AND PAY.TRCURR=1),0)-ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=1 AND PAY.PAID=0 AND PAY.TRCURR=1),0) [KALAN_USD_BAKİYE],

ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=0 AND PAY.PAID=0 AND PAY.TRCURR=20),0)-ISNULL((SELECT SUM(TOTAL) FROM LG_002_01_PAYTRANS PAY WHERE PAY.CARDREF=CLC.LOGICALREF AND PAY.CANCELLED=0 AND PAY.SIGN=1 AND PAY.PAID=0 AND PAY.TRCURR=20),0) [KALAN_EUR_BAKİYE] 

FROM LG_002_CLCARD CLC
INNER JOIN  LV_002_01_GNTOTCL GNT ON CLC.LOGICALREF=GNT.CARDREF
LEFT OUTER JOIN LG_002_SLSCLREL SLC ON CLC.LOGICALREF=SLC.CLIENTREF
LEFT OUTER JOIN LG_SLSMAN SLM ON SLM.LOGICALREF=SLC.SALESMANREF
WHERE GNT.TOTTYP=1 --AND CLC.CODE LIKE '120%'
GROUP BY CLC.CODE,CLC.DEFINITION_,CLC.LOGICALREF,SLM.CODE


GO


