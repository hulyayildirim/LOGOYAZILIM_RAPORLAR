
CREATE VIEW [dbo].[TLS_SATIŞ_DETAY_RAPORU_002] AS
SELECT

STL.DATE_ AS [TARİH],
CASE WHEN STL.STFICHEREF=0 THEN 'YOK' ELSE STF.FICHENO END AS [İRSALİYE NUMARASI],
INV.FICHENO AS [FATURA NUMARASI],
(CASE
WHEN INV.TRCODE=1   THEN 'Satınalma Faturası'
WHEN INV.TRCODE=2   THEN 'Perakende Satış İade Faturası'
WHEN INV.TRCODE=3   THEN 'Toptan Satış İade Faturası'
WHEN INV.TRCODE=4   THEN 'Alınan Hizmet Faturası'
WHEN INV.TRCODE=5   THEN 'Alınan Proforma Faturası'
WHEN INV.TRCODE=6   THEN 'Satınalma İade Faturası'
WHEN INV.TRCODE=7   THEN 'Perakende Satış Faturası'
WHEN INV.TRCODE=8   THEN 'Toptan Satış Faturası'
WHEN INV.TRCODE=9   THEN 'Verilen Hizmet Faturası'
WHEN INV.TRCODE=10  THEN 'Verilen Proforma Faturası'
WHEN INV.TRCODE=12  THEN 'Alınan Vade Farkı Faturası'
WHEN INV.TRCODE=13  THEN 'Satınalma Fiyat Farkı Faturası'
WHEN INV.TRCODE=14  THEN 'Satış Fiyat Farkı Faturası'
WHEN INV.TRCODE=26  THEN 'Müstahsil Makbuzu'
WHEN INV.TRCODE=1   THEN 'Satınalma Faturası'
WHEN INV.TRCODE=2   THEN 'Perakende Satış İade Faturası'
WHEN INV.TRCODE=3   THEN 'Toptan Satış İade Faturası'
WHEN INV.TRCODE=4   THEN 'Alınan Hizmet Faturası'
WHEN INV.TRCODE=5   THEN 'Alınan Proforma Faturası'
WHEN INV.TRCODE=6   THEN 'Satınalma İade Faturası'
WHEN INV.TRCODE=7   THEN 'Perakende Satış Faturası'
WHEN INV.TRCODE=8   THEN 'Toptan Satış Faturası'
WHEN INV.TRCODE=9   THEN 'Verilen Hizmet Faturası'
WHEN INV.TRCODE=10  THEN 'Verilen Proforma Faturası'
WHEN INV.TRCODE=12  THEN 'Alınan Vade Farkı Faturası'
WHEN INV.TRCODE=13  THEN 'Satınalma Fiyat Farkı Faturası'
WHEN INV.TRCODE=14  THEN 'Satış Fiyat Farkı Faturası'
WHEN INV.TRCODE=26  THEN 'Müstahsil Makbuzu'
END
) as [FATURA TÜRÜ],
COALESCE(ITM.CODE, SRV.CODE) AS [MALZEME/HİZMET KODU],
COALESCE(ITM.NAME, SRV.DEFINITION_) AS [MALZEME/HİZMET ADI],
COALESCE(ITM.SPECODE, SRV.SPECODE) AS [MALZEME/HİZMET ÖZEL KODU],
CLC.CODE AS [CARİ HESAP KODU],
CLC.DEFINITION_ AS [CARİ HESAP UNVANI],
CLC.SPECODE AS [CARİ HESAP ÖZEL KODU],
CONCAT(CLC.ADDR1,' ', CLC.ADDR2) AS [CARİ HESAP ADRESİ],
STL.AMOUNT AS [MİKTAR],
STL.PRICE AS [TL BİRİM FİYAT],
ROUND(CASE WHEN STL.TRRATE<>0 THEN STL.PRICE/STL.TRRATE ELSE 0 END,4) AS [DÖVİZLİ BİRİM FİYAT],
CASE WHEN STL.TRCURR=0 THEN 'TL'
WHEN STL.TRCURR=1 THEN 'USD'
WHEN STL.TRCURR=20 THEN 'EUR'
WHEN STL.TRCURR=17 THEN 'GBP' ELSE 'Diğer' END AS [SATIŞ DÖVİZ CİNSİ],
CASE WHEN INV.TRCODE=3 THEN (-1)*STL.LINENET ELSE STL.LINENET END AS [TL TOPLAM],
CASE WHEN INV.TRCODE=3 THEN (-1)*(ROUND(CASE WHEN STL.TRRATE<>0 THEN STL.LINENET/STL.TRRATE ELSE 0 END,4)) ELSE ROUND(CASE WHEN STL.TRRATE<>0 THEN STL.LINENET/STL.TRRATE ELSE 0 END,4) END AS [DÖVİZ TOPLAM],
CASE WHEN INV.TRCODE=3 THEN (-1)*STL.VATAMNT ELSE STL.VATAMNT END AS [TL KDV],
CASE WHEN INV.TRCODE=3 THEN (-1)*(STL.LINENET + STL.VATAMNT) ELSE (STL.LINENET + STL.VATAMNT) END AS [TL GENEL TOPLAM]

FROM LG_002_01_STLINE STL

LEFT OUTER JOIN LG_002_01_STFICHE STF ON STF.LOGICALREF=STL.STFICHEREF
LEFT OUTER JOIN LG_002_01_INVOICE INV ON INV.LOGICALREF=STL.INVOICEREF
LEFT OUTER JOIN LG_002_ITEMS ITM ON ITM.LOGICALREF=STL.STOCKREF
LEFT OUTER JOIN LG_002_SRVCARD SRV ON SRV.LOGICALREF=STL.STOCKREF
LEFT OUTER JOIN LG_002_CLCARD CLC ON CLC.LOGICALREF=STL.CLIENTREF

WHERE INV.GRPCODE=2
GO


