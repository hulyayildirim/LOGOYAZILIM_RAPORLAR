USE [GO3]
GO

/****** Object:  View [dbo].[TLS_XXX_BANKA_HESAP_DURUM]    Script Date: 17.08.2023 14:17:17 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[TLS_XXX_BANKA_HESAP_DURUM] AS

SELECT 
	(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=002 ) AS 'Firma',
	CASE 
		WHEN BNL.TRANSTYPE = 1 THEN '(CH) Cari Hesap'
		WHEN BNL.TRANSTYPE = 2 THEN '(THS) Tahsil Senetleri'
		WHEN BNL.TRANSTYPE = 3 THEN '(TKS) Takas Çekleri'
		WHEN BNL.TRANSTYPE = 4 THEN '(ÇEK) Kesilen Çekler'
		WHEN BNL.TRANSTYPE = 5 THEN '(TMS) Teminat Senetleri'
		WHEN BNL.TRANSTYPE = 6 THEN '(TMÇ) Teminat Çekleri'
		WHEN BNL.TRANSTYPE = 7 THEN '(SKK) Senet Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 8 THEN '(ÇKK) Çek Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 9 THEN '(TMM) Teminat Mektubu'
		WHEN BNL.TRANSTYPE = 10 THEN '(TMK) Teminatsız Kredi'	
		WHEN BNL.TRANSTYPE = 50 THEN '(KKB) Kredi Kartı Bloke'	
	ELSE '' END AS 'Banka Hesap Detayı',
	BNL.DATE_ [Tarih],
	BNL.TRANNO [İşlem No],
	BNL.LINEEXP [Açıklama],
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	AS AY,
		  CAST(YEAR(BNL.DATE_) AS VARCHAR(4)) + 
		  	LTRIM(RTRIM(	
		CASE 
		CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
		WHEN '01' THEN '01-Ocak '
		WHEN '02' THEN '02-Şubat '
		WHEN '03' THEN '03-Mart '
		WHEN '04' THEN '04-Nisan '
		WHEN '05' THEN '05-Mayıs '
		WHEN '06' THEN '06-Haziran '
		WHEN '07' THEN '07-Temmuz '					
		WHEN '08' THEN '08-Ağustos '
		WHEN '09' THEN '09-Eylül '
		WHEN '10' THEN '10-Ekim '
		WHEN '11' THEN '11-Kasım '
		WHEN '12' THEN '12-Aralık '
		ELSE '' END)) AS YIL_AY,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END AS Hafta,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END AS Gün,
	CASE WHEN BNK.CARDTYPE IN (1,2) THEN 'TL HESAP' WHEN BNK.CARDTYPE IN (3,4) THEN 'DVZ HESAP' ELSE 'DİĞER' END BANKA_TURU ,
	BANK.CODE AS 'Banka_Kodu',
	BANK.DEFINITION_ AS 'Banka_Adı',
	BNK.CODE AS 'Banka_Hesap_Kodu', 
	BNK.DEFINITION_ AS 'Banka_Hesap_Adı', 
	SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE 0 END ) BORC ,
	SUM(CASE WHEN BNL.SIGN=1 THEN (BNL.AMOUNT) ELSE 0 END ) ALACAK,
	CASE WHEN BNK.CARDTYPE=3 THEN 0 ELSE ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) END BAKİYE,
	ROUND(SUM(CASE WHEN BNL.TRCURR=0 THEN 0 WHEN BNL.SIGN=0 THEN (BNL.TRNET) ELSE BNL.TRNET*-1 END ),2) ID_BAKİYE,
	ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) TL_BAKİYE,
	YEAR(BNL.DATE_) AS YIL,
	H.CODE AS 'Muh_Hesap_Kodu',
	H.DEFINITION_ AS 'Muh_Hesap_Adı',
	ROUND(ISNULL((SELECT SUM(DEBIT-CREDIT) FROM LV_002_01_EMUHTOT WHERE ACCOUNTREF=H.LOGICALREF AND TOTTYPE=1 AND YEAR_=2022),0),2) AS 'Muh_Hesap_Bakiye',
	CASE WHEN BNL.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WITH(NOLOCK) WHERE CURR.CURTYPE=BNL.TRCURR AND CURR.FIRMNR=002) END [DVZ TÜRÜ],
	BNL.TRRATE [KUR]
FROM 
	LG_002_01_BNFLINE BNL WITH(NOLOCK)	
	INNER JOIN LG_002_BANKACC BNK WITH(NOLOCK) ON BNL.BNACCREF=BNK.LOGICALREF
	LEFT OUTER JOIN LG_002_BNCARD BANK WITH(NOLOCK) ON BNL.BANKREF=BANK.LOGICALREF
	LEFT OUTER JOIN LG_002_CRDACREF R WITH(NOLOCK) ON BNK.LOGICALREF=R.CARDREF AND R.TRCODE=6 AND R.TYP=1
	LEFT OUTER JOIN LG_002_EMUHACC H WITH(NOLOCK) ON R.ACCOUNTREF=H.LOGICALREF
WHERE 
	BNL.CANCELLED=0 
	-- AND (BNL.TRANSTYPE=1 OR BNL.TRANSTYPE=9)
	-- AND YEAR(BNL.DATE_)=2023
GROUP BY 
	BNL.TRANSTYPE,
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END,
	BANK.CODE,
	BANK.DEFINITION_,
	BNK.CODE, BNK.DEFINITION_,BNK.CARDTYPE,
	YEAR(BNL.DATE_),
	H.CODE,
	H.LOGICALREF,
	H.DEFINITION_,
	BNL.TRCURR,
	BNL.TRRATE,
	BNL.DATE_,
	BNL.TRANNO ,
	BNL.LINEEXP

	UNION ALL

	
SELECT 
	(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=001 ) AS 'Firma',
	CASE 
		WHEN BNL.TRANSTYPE = 1 THEN '(CH) Cari Hesap'
		WHEN BNL.TRANSTYPE = 2 THEN '(THS) Tahsil Senetleri'
		WHEN BNL.TRANSTYPE = 3 THEN '(TKS) Takas Çekleri'
		WHEN BNL.TRANSTYPE = 4 THEN '(ÇEK) Kesilen Çekler'
		WHEN BNL.TRANSTYPE = 5 THEN '(TMS) Teminat Senetleri'
		WHEN BNL.TRANSTYPE = 6 THEN '(TMÇ) Teminat Çekleri'
		WHEN BNL.TRANSTYPE = 7 THEN '(SKK) Senet Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 8 THEN '(ÇKK) Çek Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 9 THEN '(TMM) Teminat Mektubu'
		WHEN BNL.TRANSTYPE = 10 THEN '(TMK) Teminatsız Kredi'	
		WHEN BNL.TRANSTYPE = 50 THEN '(KKB) Kredi Kartı Bloke'	
	ELSE '' END AS 'Banka Hesap Detayı',
	BNL.DATE_ [Tarih],
	BNL.TRANNO [İşlem No],
	BNL.LINEEXP [Açıklama],
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	AS AY,
		  CAST(YEAR(BNL.DATE_) AS VARCHAR(4)) + 
		  	LTRIM(RTRIM(	
		CASE 
		CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
		WHEN '01' THEN '01-Ocak '
		WHEN '02' THEN '02-Şubat '
		WHEN '03' THEN '03-Mart '
		WHEN '04' THEN '04-Nisan '
		WHEN '05' THEN '05-Mayıs '
		WHEN '06' THEN '06-Haziran '
		WHEN '07' THEN '07-Temmuz '					
		WHEN '08' THEN '08-Ağustos '
		WHEN '09' THEN '09-Eylül '
		WHEN '10' THEN '10-Ekim '
		WHEN '11' THEN '11-Kasım '
		WHEN '12' THEN '12-Aralık '
		ELSE '' END)) AS YIL_AY,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END AS Hafta,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END AS Gün,
	CASE WHEN BNK.CARDTYPE IN (1,2) THEN 'TL HESAP' WHEN BNK.CARDTYPE IN (3,4) THEN 'DVZ HESAP' ELSE 'DİĞER' END BANKA_TURU ,
	BANK.CODE AS 'Banka_Kodu',
	BANK.DEFINITION_ AS 'Banka_Adı',
	BNK.CODE AS 'Banka_Hesap_Kodu', 
	BNK.DEFINITION_ AS 'Banka_Hesap_Adı', 
	SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE 0 END ) BORC ,
	SUM(CASE WHEN BNL.SIGN=1 THEN (BNL.AMOUNT) ELSE 0 END ) ALACAK,
	CASE WHEN BNK.CARDTYPE=3 THEN 0 ELSE ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) END BAKİYE,
	ROUND(SUM(CASE WHEN BNL.TRCURR=0 THEN 0 WHEN BNL.SIGN=0 THEN (BNL.TRNET) ELSE BNL.TRNET*-1 END ),2) ID_BAKİYE,
	ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) TL_BAKİYE,
	YEAR(BNL.DATE_) AS YIL,
	H.CODE AS 'Muh_Hesap_Kodu',
	H.DEFINITION_ AS 'Muh_Hesap_Adı',
	ROUND(ISNULL((SELECT SUM(DEBIT-CREDIT) FROM LV_001_01_EMUHTOT WHERE ACCOUNTREF=H.LOGICALREF AND TOTTYPE=1 AND YEAR_=2023),0),2) AS 'Muh_Hesap_Bakiye',
	CASE WHEN BNL.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WITH(NOLOCK) WHERE CURR.CURTYPE=BNL.TRCURR AND CURR.FIRMNR=001) END [DVZ TÜRÜ],
	BNL.TRRATE [KUR]
FROM 
	LG_001_01_BNFLINE BNL WITH(NOLOCK)	
	INNER JOIN LG_001_BANKACC BNK WITH(NOLOCK) ON BNL.BNACCREF=BNK.LOGICALREF
	LEFT OUTER JOIN LG_001_BNCARD BANK WITH(NOLOCK) ON BNL.BANKREF=BANK.LOGICALREF
	LEFT OUTER JOIN LG_001_CRDACREF R WITH(NOLOCK) ON BNK.LOGICALREF=R.CARDREF AND R.TRCODE=6 AND R.TYP=1
	LEFT OUTER JOIN LG_001_EMUHACC H WITH(NOLOCK) ON R.ACCOUNTREF=H.LOGICALREF
WHERE 
	BNL.CANCELLED=0 
	-- AND (BNL.TRANSTYPE=1 OR BNL.TRANSTYPE=9)
	-- AND YEAR(BNL.DATE_)=2023
GROUP BY 
	BNL.TRANSTYPE,
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END,
	BANK.CODE,
	BANK.DEFINITION_,
	BNK.CODE, BNK.DEFINITION_,BNK.CARDTYPE,
	YEAR(BNL.DATE_),
	H.CODE,
	H.LOGICALREF,
	H.DEFINITION_,
	BNL.TRCURR,
	BNL.TRRATE,
	BNL.DATE_,
	BNL.TRANNO ,
	BNL.LINEEXP

	UNION ALL

	
SELECT 
	(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=003 ) AS 'Firma',
	CASE 
		WHEN BNL.TRANSTYPE = 1 THEN '(CH) Cari Hesap'
		WHEN BNL.TRANSTYPE = 2 THEN '(THS) Tahsil Senetleri'
		WHEN BNL.TRANSTYPE = 3 THEN '(TKS) Takas Çekleri'
		WHEN BNL.TRANSTYPE = 4 THEN '(ÇEK) Kesilen Çekler'
		WHEN BNL.TRANSTYPE = 5 THEN '(TMS) Teminat Senetleri'
		WHEN BNL.TRANSTYPE = 6 THEN '(TMÇ) Teminat Çekleri'
		WHEN BNL.TRANSTYPE = 7 THEN '(SKK) Senet Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 8 THEN '(ÇKK) Çek Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 9 THEN '(TMM) Teminat Mektubu'
		WHEN BNL.TRANSTYPE = 10 THEN '(TMK) Teminatsız Kredi'	
		WHEN BNL.TRANSTYPE = 50 THEN '(KKB) Kredi Kartı Bloke'	
	ELSE '' END AS 'Banka Hesap Detayı',
	BNL.DATE_ [Tarih],
	BNL.TRANNO [İşlem No],
	BNL.LINEEXP [Açıklama],
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	AS AY,
		  CAST(YEAR(BNL.DATE_) AS VARCHAR(4)) + 
		  	LTRIM(RTRIM(	
		CASE 
		CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
		WHEN '01' THEN '01-Ocak '
		WHEN '02' THEN '02-Şubat '
		WHEN '03' THEN '03-Mart '
		WHEN '04' THEN '04-Nisan '
		WHEN '05' THEN '05-Mayıs '
		WHEN '06' THEN '06-Haziran '
		WHEN '07' THEN '07-Temmuz '					
		WHEN '08' THEN '08-Ağustos '
		WHEN '09' THEN '09-Eylül '
		WHEN '10' THEN '10-Ekim '
		WHEN '11' THEN '11-Kasım '
		WHEN '12' THEN '12-Aralık '
		ELSE '' END)) AS YIL_AY,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END AS Hafta,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END AS Gün,
	CASE WHEN BNK.CARDTYPE IN (1,2) THEN 'TL HESAP' WHEN BNK.CARDTYPE IN (3,4) THEN 'DVZ HESAP' ELSE 'DİĞER' END BANKA_TURU ,
	BANK.CODE AS 'Banka_Kodu',
	BANK.DEFINITION_ AS 'Banka_Adı',
	BNK.CODE AS 'Banka_Hesap_Kodu', 
	BNK.DEFINITION_ AS 'Banka_Hesap_Adı', 
	SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE 0 END ) BORC ,
	SUM(CASE WHEN BNL.SIGN=1 THEN (BNL.AMOUNT) ELSE 0 END ) ALACAK,
	CASE WHEN BNK.CARDTYPE=3 THEN 0 ELSE ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) END BAKİYE,
	ROUND(SUM(CASE WHEN BNL.TRCURR=0 THEN 0 WHEN BNL.SIGN=0 THEN (BNL.TRNET) ELSE BNL.TRNET*-1 END ),2) ID_BAKİYE,
	ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) TL_BAKİYE,
	YEAR(BNL.DATE_) AS YIL,
	H.CODE AS 'Muh_Hesap_Kodu',
	H.DEFINITION_ AS 'Muh_Hesap_Adı',
	ROUND(ISNULL((SELECT SUM(DEBIT-CREDIT) FROM LV_003_01_EMUHTOT WHERE ACCOUNTREF=H.LOGICALREF AND TOTTYPE=1 AND YEAR_=2023),0),2) AS 'Muh_Hesap_Bakiye',
	CASE WHEN BNL.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WITH(NOLOCK) WHERE CURR.CURTYPE=BNL.TRCURR AND CURR.FIRMNR=003) END [DVZ TÜRÜ],
	BNL.TRRATE [KUR]
FROM 
	LG_003_01_BNFLINE BNL WITH(NOLOCK)	
	INNER JOIN LG_003_BANKACC BNK WITH(NOLOCK) ON BNL.BNACCREF=BNK.LOGICALREF
	LEFT OUTER JOIN LG_003_BNCARD BANK WITH(NOLOCK) ON BNL.BANKREF=BANK.LOGICALREF
	LEFT OUTER JOIN LG_003_CRDACREF R WITH(NOLOCK) ON BNK.LOGICALREF=R.CARDREF AND R.TRCODE=6 AND R.TYP=1
	LEFT OUTER JOIN LG_003_EMUHACC H WITH(NOLOCK) ON R.ACCOUNTREF=H.LOGICALREF
WHERE 
	BNL.CANCELLED=0 
	-- AND (BNL.TRANSTYPE=1 OR BNL.TRANSTYPE=9)
	-- AND YEAR(BNL.DATE_)=2023
GROUP BY 
	BNL.TRANSTYPE,
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END,
	BANK.CODE,
	BANK.DEFINITION_,
	BNK.CODE, BNK.DEFINITION_,BNK.CARDTYPE,
	YEAR(BNL.DATE_),
	H.CODE,
	H.LOGICALREF,
	H.DEFINITION_,
	BNL.TRCURR,
	BNL.TRRATE,
	BNL.DATE_,
	BNL.TRANNO ,
	BNL.LINEEXP

	UNION ALL

	
SELECT 
	(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=023 ) AS 'Firma',
	CASE 
		WHEN BNL.TRANSTYPE = 1 THEN '(CH) Cari Hesap'
		WHEN BNL.TRANSTYPE = 2 THEN '(THS) Tahsil Senetleri'
		WHEN BNL.TRANSTYPE = 3 THEN '(TKS) Takas Çekleri'
		WHEN BNL.TRANSTYPE = 4 THEN '(ÇEK) Kesilen Çekler'
		WHEN BNL.TRANSTYPE = 5 THEN '(TMS) Teminat Senetleri'
		WHEN BNL.TRANSTYPE = 6 THEN '(TMÇ) Teminat Çekleri'
		WHEN BNL.TRANSTYPE = 7 THEN '(SKK) Senet Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 8 THEN '(ÇKK) Çek Karşılığı Kredi'
		WHEN BNL.TRANSTYPE = 9 THEN '(TMM) Teminat Mektubu'
		WHEN BNL.TRANSTYPE = 10 THEN '(TMK) Teminatsız Kredi'	
		WHEN BNL.TRANSTYPE = 50 THEN '(KKB) Kredi Kartı Bloke'	
	ELSE '' END AS 'Banka Hesap Detayı',
	BNL.DATE_ [Tarih],
	BNL.TRANNO [İşlem No],
	BNL.LINEEXP [Açıklama],
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	AS AY,
		  CAST(YEAR(BNL.DATE_) AS VARCHAR(4)) + 
		  	LTRIM(RTRIM(	
		CASE 
		CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
		WHEN '01' THEN '01-Ocak '
		WHEN '02' THEN '02-Şubat '
		WHEN '03' THEN '03-Mart '
		WHEN '04' THEN '04-Nisan '
		WHEN '05' THEN '05-Mayıs '
		WHEN '06' THEN '06-Haziran '
		WHEN '07' THEN '07-Temmuz '					
		WHEN '08' THEN '08-Ağustos '
		WHEN '09' THEN '09-Eylül '
		WHEN '10' THEN '10-Ekim '
		WHEN '11' THEN '11-Kasım '
		WHEN '12' THEN '12-Aralık '
		ELSE '' END)) AS YIL_AY,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END AS Hafta,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END AS Gün,
	CASE WHEN BNK.CARDTYPE IN (1,2) THEN 'TL HESAP' WHEN BNK.CARDTYPE IN (3,4) THEN 'DVZ HESAP' ELSE 'DİĞER' END BANKA_TURU ,
	BANK.CODE AS 'Banka_Kodu',
	BANK.DEFINITION_ AS 'Banka_Adı',
	BNK.CODE AS 'Banka_Hesap_Kodu', 
	BNK.DEFINITION_ AS 'Banka_Hesap_Adı', 
	SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE 0 END ) BORC ,
	SUM(CASE WHEN BNL.SIGN=1 THEN (BNL.AMOUNT) ELSE 0 END ) ALACAK,
	CASE WHEN BNK.CARDTYPE=3 THEN 0 ELSE ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) END BAKİYE,
	ROUND(SUM(CASE WHEN BNL.TRCURR=0 THEN 0 WHEN BNL.SIGN=0 THEN (BNL.TRNET) ELSE BNL.TRNET*-1 END ),2) ID_BAKİYE,
	ROUND(SUM(CASE WHEN BNL.SIGN=0 THEN (BNL.AMOUNT) ELSE BNL.AMOUNT*-1 END ),2) TL_BAKİYE,
	YEAR(BNL.DATE_) AS YIL,
	H.CODE AS 'Muh_Hesap_Kodu',
	H.DEFINITION_ AS 'Muh_Hesap_Adı',
	ROUND(ISNULL((SELECT SUM(DEBIT-CREDIT) FROM LV_023_01_EMUHTOT WHERE ACCOUNTREF=H.LOGICALREF AND TOTTYPE=1 AND YEAR_=2023),0),2) AS 'Muh_Hesap_Bakiye',
	CASE WHEN BNL.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WITH(NOLOCK) WHERE CURR.CURTYPE=BNL.TRCURR AND CURR.FIRMNR=023) END [DVZ TÜRÜ],
	BNL.TRRATE [KUR]
FROM 
	LG_023_01_BNFLINE BNL WITH(NOLOCK)	
	INNER JOIN LG_023_BANKACC BNK WITH(NOLOCK) ON BNL.BNACCREF=BNK.LOGICALREF
	LEFT OUTER JOIN LG_023_BNCARD BANK WITH(NOLOCK) ON BNL.BANKREF=BANK.LOGICALREF
	LEFT OUTER JOIN LG_023_CRDACREF R WITH(NOLOCK) ON BNK.LOGICALREF=R.CARDREF AND R.TRCODE=6 AND R.TYP=1
	LEFT OUTER JOIN LG_023_EMUHACC H WITH(NOLOCK) ON R.ACCOUNTREF=H.LOGICALREF
WHERE 
	BNL.CANCELLED=0 
	-- AND (BNL.TRANSTYPE=1 OR BNL.TRANSTYPE=9)
	-- AND YEAR(BNL.DATE_)=2023
GROUP BY 
	BNL.TRANSTYPE,
	LTRIM(RTRIM(	
	CASE 
	CASE LEN(CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(MM,BNL.DATE_) AS VARCHAR) END 
	WHEN '01' THEN '01-Ocak '
	WHEN '02' THEN '02-Şubat '
	WHEN '03' THEN '03-Mart '
	WHEN '04' THEN '04-Nisan '
	WHEN '05' THEN '05-Mayıs '
	WHEN '06' THEN '06-Haziran '
	WHEN '07' THEN '07-Temmuz '					
	WHEN '08' THEN '08-Ağustos '
	WHEN '09' THEN '09-Eylül '
	WHEN '10' THEN '10-Ekim '
	WHEN '11' THEN '11-Kasım '
	WHEN '12' THEN '12-Aralık '
	ELSE '' END))
	,
	CASE LEN(CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(wk,BNL.DATE_) AS VARCHAR) END,
	CASE LEN(CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR)) WHEN 1 THEN '0'+CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) ELSE CAST(DATEPART(dd,BNL.DATE_) AS VARCHAR) END,
	BANK.CODE,
	BANK.DEFINITION_,
	BNK.CODE, BNK.DEFINITION_,BNK.CARDTYPE,
	YEAR(BNL.DATE_),
	H.CODE,
	H.LOGICALREF,
	H.DEFINITION_,
	BNL.TRCURR,
	BNL.TRRATE,
	BNL.DATE_,
	BNL.TRANNO ,
	BNL.LINEEXP

GO


