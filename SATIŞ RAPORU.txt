USE [GO3]
GO

/****** Object:  View [dbo].[TLS_SATIS_RAPORU]    Script Date: 17.08.2023 14:15:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE VIEW [dbo].[TLS_SATIS_RAPORU] AS

SELECT 
'23' [FİRMA NO], 
'ECZACIN SAĞLIK' [FİRMA ADI],
YEAR(STL.DATE_) AS 'YIL',
MONTH(STL.DATE_) AS 'AY',
STL.DATE_ [TARİH],
CW.NR [AMBAR NO],
CW.NAME [AMBAR ADI],
CASE WHEN STL.LINETYPE=4 THEN SRV.CODE ELSE ITEMS.CODE END AS [STOK KODU],
CASE WHEN STL.LINETYPE=4 THEN SRV.DEFINITION_ ELSE ITEMS.NAME END AS [STOK ADI],
BRC.BARCODE  [BARKOD],
LOTN.CODE [LOT],
ISNULL( S1.DEFINITION_ ,'') AS [ÖZEL KOD1],
ISNULL( S2.DEFINITION_ ,'')  AS [ÖZEL KOD2],
ISNULL( S3.DEFINITION_ ,'') AS [ÖZEL KOD3],
ISNULL( S4.DEFINITION_ ,'')  AS [ÖZEL KOD4],
ISNULL( ITEMS.SPECODE5 ,'')  AS [ÖZEL KOD5],
ITEMS.STGRPCODE  AS [GRUP KODU],
CASE WHEN STF.TRCODE IN (2,3) THEN (STL.AMOUNT*-1)
ELSE STL.AMOUNT END [SATIŞ MİKTAR],
CASE WHEN STF.TRCODE IN (2,3) THEN (STL.VATMATRAH*-1)
ELSE STL.VATMATRAH END [SATIŞ MATRAH],
STL.VAT [KDV ORAN],
CASE WHEN STF.TRCODE IN (2,3) THEN (STL.VATAMNT*-1)
ELSE STL.VATAMNT END [KDV TUTAR],
CASE WHEN STF.TRCODE IN (2,3) THEN ((STL.VATMATRAH+STL.VATAMNT)*-1)
ELSE (STL.VATMATRAH+STL.VATAMNT) END [GENEL TOPLAM],
STL.OUTCOST [ALIŞ FİYATI],
(STL.PRICE-STL.OUTCOST) [BRÜT KARLILIK],
INV.FICHENO [SATIŞ FATURA NO],
STF.FICHENO [SATIŞ İRSALİYE NO],
(CASE
WHEN STF.TRCODE=2 THEN 'Perakende Satış İade İrsaliyesi'
WHEN STF.TRCODE=3 THEN 'Toptan Satış İade İrsaliyesi'
WHEN STF.TRCODE=4 THEN 'Konsinye Çıkış İade İrsaliyesi'
WHEN STF.TRCODE=7 THEN 'Perakende Satış İrsaliyesi'
WHEN STF.TRCODE=8 THEN 'Toptan Satış İrsaliyesi'
WHEN STF.TRCODE=9 THEN 'Konsinye Çıkış İrsaliyesi' END
)as [İRSALİYE TÜRÜ],
(CASE
WHEN INV.TRCODE=1 THEN 'Satınalma Faturası'
WHEN INV.TRCODE=2 THEN 'Perakende Satış İade Faturası'
WHEN INV.TRCODE=3 THEN 'Toptan Satış İade Faturası'
WHEN INV.TRCODE=4 THEN 'Alınan Hizmet Faturası'
WHEN INV.TRCODE=5 THEN 'Alınan Proforma Faturası'
WHEN INV.TRCODE=6 THEN 'Satınalma İade Faturası'
WHEN INV.TRCODE=7 THEN 'Perakende Satış Faturası'
WHEN INV.TRCODE=8 THEN 'Toptan Satış Faturası' 
WHEN INV.TRCODE=9 THEN 'Verilen Hizmet Faturası'
WHEN INV.TRCODE=10 THEN 'Verilen Proforma Faturası'
WHEN INV.TRCODE=12 THEN 'Alınan Vade Farkı Faturası'
WHEN INV.TRCODE=13 THEN 'Satınalma Fiyat Farkı Faturası'
wHEN INV.TRCODE=14 THEN 'Satış Fiyat Farkı Faturası'
WHEN INV.TRCODE=26 THEN 'Müstahsil Makbuzu' END
) as [Fatura Tipi],

CLC.CODE [CARİ KOD],
CLC.DEFINITION_ [CARİ UNVAN],
CLC.SPECODE [CARİ ÖZEL KOD],
INV.SPECODE [FATURA ÖZEL KOD],
CLC.ADDR1 [CARİ ADRES1],
CLC.ADDR2 [CARİ ADRES2],
CLC.TOWN [CARİ İLÇE],
CLC.CITY [CARİ İL]


FROM  LG_023_01_STLINE AS  STL 
LEFT OUTER JOIN LG_023_ITEMS ITEMS WITH(NOLOCK) ON  STL.STOCKREF=ITEMS.LOGICALREF AND STL.LINETYPE=0
LEFT OUTER JOIN LG_023_UNITBARCODE BRC WITH(NOLOCK) ON ITEMS.LOGICALREF=BRC.ITEMREF AND BRC.LINENR=1
LEFT OUTER JOIN LG_023_SRVCARD SRV WITH(NOLOCK) ON SRV.LOGICALREF=STL.STOCKREF AND STL.LINETYPE=4
LEFT OUTER JOIN LG_023_SPECODES S1 WITH(NOLOCK) ON  ITEMS.SPECODE=S1.SPECODE AND S1.CODETYPE=1 AND S1.SPECODETYPE=1 AND S1.SPETYP1=1 
LEFT OUTER JOIN LG_023_SPECODES S2 WITH(NOLOCK) ON  ITEMS.SPECODE2=S2.SPECODE AND S2.CODETYPE=1 AND S2.SPECODETYPE=1 AND S2.SPETYP1=0
LEFT OUTER JOIN LG_023_SPECODES S3 WITH(NOLOCK) ON  ITEMS.SPECODE3=S3.SPECODE AND S3.CODETYPE=1 AND S3.SPECODETYPE=1 AND S3.SPETYP1=0
LEFT OUTER JOIN LG_023_SPECODES S4 WITH(NOLOCK) ON  ITEMS.SPECODE4=S4.SPECODE AND S4.CODETYPE=1 AND S4.SPECODETYPE=1 AND S4.SPETYP1=0
LEFT OUTER JOIN LG_023_01_SLTRANS SLT WITH(NOLOCK) ON STL.LOGICALREF=SLT.STTRANSREF
LEFT OUTER JOIN LG_023_CLCARD CLC WITH(NOLOCK) ON CLC.LOGICALREF=STL.CLIENTREF
LEFT OUTER JOIN LG_023_01_STFICHE STF WITH(NOLOCK) ON STF.LOGICALREF=SLT.STFICHEREF AND STL.INVOICEREF=STF.INVOICEREF
LEFT OUTER JOIN LG_023_01_INVOICE INV WITH(NOLOCK) ON INV.LOGICALREF=STL.INVOICEREF AND INV.CLIENTREF=CLC.LOGICALREF
LEFT OUTER JOIN LV_023_01_GNTOTST GNT WITH(NOLOCK) ON GNT.STOCKREF=ITEMS.LOGICALREF AND GNT.INVENNO=SLT.INVENNO
LEFT OUTER JOIN L_CAPIWHOUSE CW WITH(NOLOCK) ON CW.NR=SLT.INVENNO AND CW.FIRMNR=23
LEFT OUTER JOIN LG_023_01_SERILOTN LOTN WITH(NOLOCK) ON LOTN.LOGICALREF=SLT.SLREF AND LOTN.ITEMREF=ITEMS.LOGICALREF
WHERE
STL.TRCODE IN (2,3,7,8)
--AND ITEMS.CODE='2532'
GROUP BY SLT.SLREF,CW.NR,ITEMS.CODE,ITEMS.NAME,BRC.BARCODE,LOTN.CODE,ITEMS.SPECODE,S1.DEFINITION_,ITEMS.SPECODE2,S2.DEFINITION_,ITEMS.SPECODE3,S3.DEFINITION_
,ITEMS.SPECODE4,S4.DEFINITION_,ITEMS.SPECODE5,ITEMS.STGRPCODE,ITEMS.VAT,GNT.ONHAND,GNT.RESERVED,GNT.PURAMNT,GNT.SALAMNT,GNT.SALCASH,GNT.PURCASH,CW.NAME
,STL.AMOUNT,STL.VATMATRAH,STL.PRICE,STL.VATAMNT,STL.OUTCOST,STL.VAT,INV.FICHENO,STF.FICHENO,STF.TRCODE,CLC.CODE,CLC.DEFINITION_,CLC.SPECODE,STL.DATE_,
INV.SPECODE,CLC.ADDR1,CLC.ADDR2,CLC.TOWN,CLC.CITY,INV.TRCODE,STL.LINETYPE,SRV.DEFINITION_,SRV.CODE


GO


