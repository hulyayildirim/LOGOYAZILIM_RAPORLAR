USE [GO3]
GO

/****** Object:  View [dbo].[TLS_XXX_BORC_TAKIP_DETAY]    Script Date: 17.08.2023 14:18:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[TLS_XXX_BORC_TAKIP_DETAY] AS
SELECT 
(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=002 ) AS 'Firma',
LEFT(CLC.CODE,3) CH_GRUP,
CLC.CODE CH_KODU,
LEFT(CLC.DEFINITION_,50) CH_ÜNVANI,
CLC.SPECODE CH_OZEL_KODU,
PAY.PROCDATE [İŞLEM TARİHİ],
PAY.DATE_ [VADE TARİHİ],
DATEDIFF(DAY,GETDATE(),PAY.DATE_) [GÜN],
CASE WHEN DATEDIFF(DAY,GETDATE(),PAY.DATE_)>0 THEN 'Vadesi Gelecek'
ELSE 'Vadesi Geçmiş' END [Dağılım],
ISNULL(INV.CYPHCODE,'') FATURA_YETKI_KODU,
PAY.TRCODE [TÜR],
CASE 
WHEN PAY.MODULENR=4 AND INV.TRCODE=1 THEN 'SATIN ALMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=2 THEN 'PERAKENDE SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=3 THEN 'TOPTAN SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=4 THEN 'ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=5 THEN 'ALINAN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=6 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=7 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=8 THEN 'TOPTAN SATIŞ FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=10 THEN 'VERİLEN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=13 THEN 'SATINALMA FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=14 THEN 'SATIŞ FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=26	THEN 'MÜSTAHSİL MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=1	THEN 'NAKİT TAHSİLAT' 
WHEN PAY.MODULENR=5 AND PAY.TRCODE=2 THEN 'NAKİT ÖDEME'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=3 THEN 'BORÇ DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=4 THEN 'ALACAK DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=5 THEN 'VİRMAN FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=6 THEN 'KUR FARKI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=12 THEN 'ÖZEL FİŞ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=14 THEN 'AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=41 THEN 'VERİLEN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=42 THEN 'ALINAN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=45 THEN 'VERİLEN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=46 THEN 'ALINAN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=70 THEN 'KREDİ KARTI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=71 THEN 'KREDİ KARTI İADE FİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=1 THEN 'ÇEK GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=2 THEN 'SENET GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=3 THEN 'ÇEK ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=4 THEN 'SENET ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=5 THEN 'ÇEK ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=6 THEN 'SENET ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=7 THEN 'ÇEK ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=8 THEN 'SENET ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=9 THEN 'İŞLEM BORDROSU (MÜŞTERİ ÇEKİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=10 THEN 'İŞLEM BORDROSU (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=11 THEN 'İŞLEM BORDROSU (KENDİ ÇEKİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=12 THEN 'İŞLEM BORDROSU (BORÇ SENEDİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=13 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=14 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=1	THEN 'BANKA İŞLEM FİŞİ' 
WHEN PAY.MODULENR=7 AND BNT.TRCODE=2 THEN 'BANKA VİRMAN FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=3 THEN 'GELEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=4 THEN 'VERİLEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=5 THEN 'BANKA AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=6 THEN 'BANKA KUR FARKI FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=16 THEN 'BANKA ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=17 THEN 'BANKA VERİLEN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=18 THEN 'BANKADAN ÇEK ÖDEMESİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=19 THEN 'BANKADAN SENET ÖDEMESİ'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (11) THEN 'KASADAN CARİ HESAP TAHSİLAT'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (12)  THEN 'KASADAN CARİ HESAP ÖDEME'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (21,22)  THEN 'KASADAN BANKA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (31,32,33,34,35,36,37,38,39)  THEN 'KASADAN FATURA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (61,62,63,64)  THEN 'KASADAN ÇEK/SENET'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (71,72,73,74)  THEN 'KASADAN KASA'
WHEN PAY.MODULENR=61 AND PAY.TRCODE=3 THEN 'KARŞILIKSIZ ÇEK/SENET BORÇ DEKONTU' 
ELSE 'DİĞER' END MODÜL,
CASE 
WHEN PAY.MODULENR=4				THEN INV.FICHENO 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.FICHENO
ELSE '' END [FİŞ NO],


CASE 
WHEN PAY.MODULENR=4				THEN INV.DOCODE 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.DOCODE
ELSE '' END [BELGE NO],



CASE 
WHEN PAY.MODULENR=4				THEN INV.GENEXP1 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.LINEEXP
WHEN PAY.MODULENR=6				THEN 'CEK-SENET GİRİŞİ' 
WHEN PAY.MODULENR=7				THEN BNT.LINEEXP 
WHEN PAY.MODULENR=10			THEN KSL.LINEEXP
ELSE '' END AÇIKLAMA,

CASE WHEN PAY.TRCURR IN (0,160) THEN PAY.TOTAL ELSE 
CASE WHEN PAY.TRRATE>0 THEN 
PAY.TOTAL*PAY.TRRATE ELSE PAY.TOTAL END END [TUTAR],

CASE WHEN PAY.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WHERE CURR.CURTYPE=PAY.TRCURR AND CURR.FIRMNR=2) END [DVZ_TÜRÜ],

PAY.TOTAL DVZ_TUTAR,
DATEPART(MONTH,PAY.DATE_) [DÖNEM],
DATEPART(YEAR,PAY.DATE_) [YIL],
(SELECT EMU.CODE FROM LG_002_EMUHACC EMU,LG_002_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP KODU],
(SELECT EMU.DEFINITION_ FROM LG_002_EMUHACC EMU,LG_002_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP AÇIKLAMASI]
 FROM 
LG_002_CLCARD CLC							WITH(NOLOCK)  INNER JOIN 
LG_002_01_PAYTRANS PAY						WITH(NOLOCK) ON (PAY.CARDREF=CLC.LOGICALREF)
LEFT OUTER JOIN LG_002_01_INVOICE INV		WITH(NOLOCK) ON (PAY.FICHEREF  =  INV.LOGICALREF)  AND (PAY.MODULENR=4)
LEFT OUTER JOIN LG_002_01_CLFLINE CLF		WITH(NOLOCK) ON (PAY.FICHEREF  =  CLF.LOGICALREF)  AND (PAY.MODULENR IN (5,61,62))
LEFT OUTER JOIN LG_002_01_BNFLINE BNT		WITH(NOLOCK) ON (PAY.FICHEREF  =  BNT.LOGICALREF)  AND  (PAY.MODULENR=7)
LEFT OUTER JOIN LG_002_01_KSLINES KSL		WITH(NOLOCK) ON (PAY.FICHEREF  =  KSL.LOGICALREF) AND (PAY.MODULENR=10) 
LEFT OUTER JOIN LG_002_01_CSROLL CSR		WITH(NOLOCK) ON (PAY.FICHEREF  =  CSR.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_002_01_CSTRANS CST		WITH(NOLOCK) ON (PAY.FICHELINEREF  =  CST.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_002_01_CSCARD  CSC		WITH(NOLOCK) ON (CST.CSREF  =  CSC.LOGICALREF)   AND  (PAY.MODULENR=6)

 WHERE 
PAY.CANCELLED=0 AND PAY.PAID=0 --AND CAST(PAY.DATE_ AS DATE)<CAST(GETDATE() AS DATE)
AND PAY.SIGN=0 
AND PAY.TRCODE NOT IN (3,5,9) 

UNION ALL


SELECT 
(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=001 ) AS 'Firma',
LEFT(CLC.CODE,3) CH_GRUP,
CLC.CODE CH_KODU,
LEFT(CLC.DEFINITION_,50) CH_ÜNVANI,
CLC.SPECODE CH_OZEL_KODU,
PAY.PROCDATE [İŞLEM TARİHİ],
PAY.DATE_ [VADE TARİHİ],
DATEDIFF(DAY,GETDATE(),PAY.DATE_) [GÜN],
CASE WHEN DATEDIFF(DAY,GETDATE(),PAY.DATE_)>0 THEN 'Vadesi Gelecek'
ELSE 'Vadesi Geçmiş' END [Dağılım],
ISNULL(INV.CYPHCODE,'') FATURA_YETKI_KODU,
PAY.TRCODE [TÜR],
CASE 
WHEN PAY.MODULENR=4 AND INV.TRCODE=1 THEN 'SATIN ALMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=2 THEN 'PERAKENDE SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=3 THEN 'TOPTAN SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=4 THEN 'ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=5 THEN 'ALINAN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=6 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=7 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=8 THEN 'TOPTAN SATIŞ FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=10 THEN 'VERİLEN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=13 THEN 'SATINALMA FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=14 THEN 'SATIŞ FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=26	THEN 'MÜSTAHSİL MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=1	THEN 'NAKİT TAHSİLAT' 
WHEN PAY.MODULENR=5 AND PAY.TRCODE=2 THEN 'NAKİT ÖDEME'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=3 THEN 'BORÇ DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=4 THEN 'ALACAK DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=5 THEN 'VİRMAN FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=6 THEN 'KUR FARKI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=12 THEN 'ÖZEL FİŞ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=14 THEN 'AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=41 THEN 'VERİLEN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=42 THEN 'ALINAN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=45 THEN 'VERİLEN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=46 THEN 'ALINAN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=70 THEN 'KREDİ KARTI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=71 THEN 'KREDİ KARTI İADE FİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=1 THEN 'ÇEK GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=2 THEN 'SENET GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=3 THEN 'ÇEK ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=4 THEN 'SENET ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=5 THEN 'ÇEK ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=6 THEN 'SENET ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=7 THEN 'ÇEK ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=8 THEN 'SENET ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=9 THEN 'İŞLEM BORDROSU (MÜŞTERİ ÇEKİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=10 THEN 'İŞLEM BORDROSU (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=11 THEN 'İŞLEM BORDROSU (KENDİ ÇEKİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=12 THEN 'İŞLEM BORDROSU (BORÇ SENEDİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=13 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=14 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=1	THEN 'BANKA İŞLEM FİŞİ' 
WHEN PAY.MODULENR=7 AND BNT.TRCODE=2 THEN 'BANKA VİRMAN FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=3 THEN 'GELEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=4 THEN 'VERİLEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=5 THEN 'BANKA AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=6 THEN 'BANKA KUR FARKI FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=16 THEN 'BANKA ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=17 THEN 'BANKA VERİLEN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=18 THEN 'BANKADAN ÇEK ÖDEMESİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=19 THEN 'BANKADAN SENET ÖDEMESİ'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (11) THEN 'KASADAN CARİ HESAP TAHSİLAT'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (12)  THEN 'KASADAN CARİ HESAP ÖDEME'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (21,22)  THEN 'KASADAN BANKA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (31,32,33,34,35,36,37,38,39)  THEN 'KASADAN FATURA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (61,62,63,64)  THEN 'KASADAN ÇEK/SENET'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (71,72,73,74)  THEN 'KASADAN KASA'
WHEN PAY.MODULENR=61 AND PAY.TRCODE=3 THEN 'KARŞILIKSIZ ÇEK/SENET BORÇ DEKONTU' 
ELSE 'DİĞER' END MODÜL,
CASE 
WHEN PAY.MODULENR=4				THEN INV.FICHENO 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.FICHENO
ELSE '' END [FİŞ NO],


CASE 
WHEN PAY.MODULENR=4				THEN INV.DOCODE 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.DOCODE
ELSE '' END [BELGE NO],



CASE 
WHEN PAY.MODULENR=4				THEN INV.GENEXP1 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.LINEEXP
WHEN PAY.MODULENR=6				THEN 'CEK-SENET GİRİŞİ' 
WHEN PAY.MODULENR=7				THEN BNT.LINEEXP 
WHEN PAY.MODULENR=10			THEN KSL.LINEEXP
ELSE '' END AÇIKLAMA,

CASE WHEN PAY.TRCURR IN (0,160) THEN PAY.TOTAL ELSE 
CASE WHEN PAY.TRRATE>0 THEN 
PAY.TOTAL*PAY.TRRATE ELSE PAY.TOTAL END END [TUTAR],

CASE WHEN PAY.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WHERE CURR.CURTYPE=PAY.TRCURR AND CURR.FIRMNR=1) END [DVZ_TÜRÜ],

PAY.TOTAL DVZ_TUTAR,
DATEPART(MONTH,PAY.DATE_) [DÖNEM],
DATEPART(YEAR,PAY.DATE_) [YIL],
(SELECT EMU.CODE FROM LG_001_EMUHACC EMU,LG_001_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP KODU],
(SELECT EMU.DEFINITION_ FROM LG_001_EMUHACC EMU,LG_001_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP AÇIKLAMASI]
 FROM 
LG_001_CLCARD CLC							WITH(NOLOCK)  INNER JOIN 
LG_001_01_PAYTRANS PAY						WITH(NOLOCK) ON (PAY.CARDREF=CLC.LOGICALREF)
LEFT OUTER JOIN LG_001_01_INVOICE INV		WITH(NOLOCK) ON (PAY.FICHEREF  =  INV.LOGICALREF)  AND (PAY.MODULENR=4)
LEFT OUTER JOIN LG_001_01_CLFLINE CLF		WITH(NOLOCK) ON (PAY.FICHEREF  =  CLF.LOGICALREF)  AND (PAY.MODULENR IN (5,61,62))
LEFT OUTER JOIN LG_001_01_BNFLINE BNT		WITH(NOLOCK) ON (PAY.FICHEREF  =  BNT.LOGICALREF)  AND  (PAY.MODULENR=7)
LEFT OUTER JOIN LG_001_01_KSLINES KSL		WITH(NOLOCK) ON (PAY.FICHEREF  =  KSL.LOGICALREF) AND (PAY.MODULENR=10) 
LEFT OUTER JOIN LG_001_01_CSROLL CSR		WITH(NOLOCK) ON (PAY.FICHEREF  =  CSR.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_001_01_CSTRANS CST		WITH(NOLOCK) ON (PAY.FICHELINEREF  =  CST.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_001_01_CSCARD  CSC		WITH(NOLOCK) ON (CST.CSREF  =  CSC.LOGICALREF)   AND  (PAY.MODULENR=6)

 WHERE 
PAY.CANCELLED=0 AND PAY.PAID=0 --AND CAST(PAY.DATE_ AS DATE)<CAST(GETDATE() AS DATE)
AND PAY.SIGN=0 
AND PAY.TRCODE NOT IN (3,5,9) 

UNION ALL


SELECT 
(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=003 ) AS 'Firma',
LEFT(CLC.CODE,3) CH_GRUP,
CLC.CODE CH_KODU,
LEFT(CLC.DEFINITION_,50) CH_ÜNVANI,
CLC.SPECODE CH_OZEL_KODU,
PAY.PROCDATE [İŞLEM TARİHİ],
PAY.DATE_ [VADE TARİHİ],
DATEDIFF(DAY,GETDATE(),PAY.DATE_) [GÜN],
CASE WHEN DATEDIFF(DAY,GETDATE(),PAY.DATE_)>0 THEN 'Vadesi Gelecek'
ELSE 'Vadesi Geçmiş' END [Dağılım],
ISNULL(INV.CYPHCODE,'') FATURA_YETKI_KODU,
PAY.TRCODE [TÜR],
CASE 
WHEN PAY.MODULENR=4 AND INV.TRCODE=1 THEN 'SATIN ALMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=2 THEN 'PERAKENDE SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=3 THEN 'TOPTAN SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=4 THEN 'ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=5 THEN 'ALINAN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=6 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=7 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=8 THEN 'TOPTAN SATIŞ FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=10 THEN 'VERİLEN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=13 THEN 'SATINALMA FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=14 THEN 'SATIŞ FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=26	THEN 'MÜSTAHSİL MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=1	THEN 'NAKİT TAHSİLAT' 
WHEN PAY.MODULENR=5 AND PAY.TRCODE=2 THEN 'NAKİT ÖDEME'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=3 THEN 'BORÇ DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=4 THEN 'ALACAK DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=5 THEN 'VİRMAN FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=6 THEN 'KUR FARKI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=12 THEN 'ÖZEL FİŞ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=14 THEN 'AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=41 THEN 'VERİLEN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=42 THEN 'ALINAN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=45 THEN 'VERİLEN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=46 THEN 'ALINAN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=70 THEN 'KREDİ KARTI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=71 THEN 'KREDİ KARTI İADE FİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=1 THEN 'ÇEK GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=2 THEN 'SENET GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=3 THEN 'ÇEK ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=4 THEN 'SENET ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=5 THEN 'ÇEK ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=6 THEN 'SENET ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=7 THEN 'ÇEK ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=8 THEN 'SENET ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=9 THEN 'İŞLEM BORDROSU (MÜŞTERİ ÇEKİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=10 THEN 'İŞLEM BORDROSU (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=11 THEN 'İŞLEM BORDROSU (KENDİ ÇEKİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=12 THEN 'İŞLEM BORDROSU (BORÇ SENEDİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=13 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=14 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=1	THEN 'BANKA İŞLEM FİŞİ' 
WHEN PAY.MODULENR=7 AND BNT.TRCODE=2 THEN 'BANKA VİRMAN FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=3 THEN 'GELEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=4 THEN 'VERİLEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=5 THEN 'BANKA AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=6 THEN 'BANKA KUR FARKI FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=16 THEN 'BANKA ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=17 THEN 'BANKA VERİLEN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=18 THEN 'BANKADAN ÇEK ÖDEMESİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=19 THEN 'BANKADAN SENET ÖDEMESİ'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (11) THEN 'KASADAN CARİ HESAP TAHSİLAT'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (12)  THEN 'KASADAN CARİ HESAP ÖDEME'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (21,22)  THEN 'KASADAN BANKA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (31,32,33,34,35,36,37,38,39)  THEN 'KASADAN FATURA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (61,62,63,64)  THEN 'KASADAN ÇEK/SENET'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (71,72,73,74)  THEN 'KASADAN KASA'
WHEN PAY.MODULENR=61 AND PAY.TRCODE=3 THEN 'KARŞILIKSIZ ÇEK/SENET BORÇ DEKONTU' 
ELSE 'DİĞER' END MODÜL,
CASE 
WHEN PAY.MODULENR=4				THEN INV.FICHENO 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.FICHENO
ELSE '' END [FİŞ NO],


CASE 
WHEN PAY.MODULENR=4				THEN INV.DOCODE 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.DOCODE
ELSE '' END [BELGE NO],



CASE 
WHEN PAY.MODULENR=4				THEN INV.GENEXP1 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.LINEEXP
WHEN PAY.MODULENR=6				THEN 'CEK-SENET GİRİŞİ' 
WHEN PAY.MODULENR=7				THEN BNT.LINEEXP 
WHEN PAY.MODULENR=10			THEN KSL.LINEEXP
ELSE '' END AÇIKLAMA,

CASE WHEN PAY.TRCURR IN (0,160) THEN PAY.TOTAL ELSE 
CASE WHEN PAY.TRRATE>0 THEN 
PAY.TOTAL*PAY.TRRATE ELSE PAY.TOTAL END END [TUTAR],

CASE WHEN PAY.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WHERE CURR.CURTYPE=PAY.TRCURR AND CURR.FIRMNR=3) END [DVZ_TÜRÜ],

PAY.TOTAL DVZ_TUTAR,
DATEPART(MONTH,PAY.DATE_) [DÖNEM],
DATEPART(YEAR,PAY.DATE_) [YIL],
(SELECT EMU.CODE FROM LG_003_EMUHACC EMU,LG_003_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP KODU],
(SELECT EMU.DEFINITION_ FROM LG_003_EMUHACC EMU,LG_003_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP AÇIKLAMASI]
 FROM 
LG_003_CLCARD CLC							WITH(NOLOCK)  INNER JOIN 
LG_003_01_PAYTRANS PAY						WITH(NOLOCK) ON (PAY.CARDREF=CLC.LOGICALREF)
LEFT OUTER JOIN LG_003_01_INVOICE INV		WITH(NOLOCK) ON (PAY.FICHEREF  =  INV.LOGICALREF)  AND (PAY.MODULENR=4)
LEFT OUTER JOIN LG_003_01_CLFLINE CLF		WITH(NOLOCK) ON (PAY.FICHEREF  =  CLF.LOGICALREF)  AND (PAY.MODULENR IN (5,61,62))
LEFT OUTER JOIN LG_003_01_BNFLINE BNT		WITH(NOLOCK) ON (PAY.FICHEREF  =  BNT.LOGICALREF)  AND  (PAY.MODULENR=7)
LEFT OUTER JOIN LG_003_01_KSLINES KSL		WITH(NOLOCK) ON (PAY.FICHEREF  =  KSL.LOGICALREF) AND (PAY.MODULENR=10) 
LEFT OUTER JOIN LG_003_01_CSROLL CSR		WITH(NOLOCK) ON (PAY.FICHEREF  =  CSR.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_003_01_CSTRANS CST		WITH(NOLOCK) ON (PAY.FICHELINEREF  =  CST.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_003_01_CSCARD  CSC		WITH(NOLOCK) ON (CST.CSREF  =  CSC.LOGICALREF)   AND  (PAY.MODULENR=6)

 WHERE 
PAY.CANCELLED=0 AND PAY.PAID=0 --AND CAST(PAY.DATE_ AS DATE)<CAST(GETDATE() AS DATE)
AND PAY.SIGN=0 
AND PAY.TRCODE NOT IN (3,5,9) 

UNION ALL

SELECT 
(SELECT CASE WHEN LEN(CAST(NR AS VARCHAR(3)))=1 THEN '00'+CAST(NR AS VARCHAR(3)) WHEN LEN(CAST(NR AS VARCHAR(3)))=2 THEN '0'+CAST(NR AS VARCHAR(3)) ELSE  CAST(NR AS VARCHAR(3)) END + ' - ' + TITLE FROM L_CAPIFIRM WHERE NR=023 ) AS 'Firma',
LEFT(CLC.CODE,3) CH_GRUP,
CLC.CODE CH_KODU,
LEFT(CLC.DEFINITION_,50) CH_ÜNVANI,
CLC.SPECODE CH_OZEL_KODU,
PAY.PROCDATE [İŞLEM TARİHİ],
PAY.DATE_ [VADE TARİHİ],
DATEDIFF(DAY,GETDATE(),PAY.DATE_) [GÜN],
CASE WHEN DATEDIFF(DAY,GETDATE(),PAY.DATE_)>0 THEN 'Vadesi Gelecek'
ELSE 'Vadesi Geçmiş' END [Dağılım],
ISNULL(INV.CYPHCODE,'') FATURA_YETKI_KODU,
PAY.TRCODE [TÜR],
CASE 
WHEN PAY.MODULENR=4 AND INV.TRCODE=1 THEN 'SATIN ALMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=2 THEN 'PERAKENDE SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=3 THEN 'TOPTAN SATIŞ İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=4 THEN 'ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=5 THEN 'ALINAN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=6 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=7 THEN 'SATINALMA İADE FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=8 THEN 'TOPTAN SATIŞ FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=10 THEN 'VERİLEN PROFORMA FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=13 THEN 'SATINALMA FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=14 THEN 'SATIŞ FİYAT FARKI FATURASI'
WHEN PAY.MODULENR=4 AND INV.TRCODE=26	THEN 'MÜSTAHSİL MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=1	THEN 'NAKİT TAHSİLAT' 
WHEN PAY.MODULENR=5 AND PAY.TRCODE=2 THEN 'NAKİT ÖDEME'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=3 THEN 'BORÇ DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=4 THEN 'ALACAK DEKONTU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=5 THEN 'VİRMAN FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=6 THEN 'KUR FARKI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=12 THEN 'ÖZEL FİŞ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=14 THEN 'AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=41 THEN 'VERİLEN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=42 THEN 'ALINAN VADE FARKI FATURASI'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=45 THEN 'VERİLEN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=46 THEN 'ALINAN SERBEST MESLEK MAKBUZU'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=70 THEN 'KREDİ KARTI FİŞİ'
WHEN PAY.MODULENR=5 AND PAY.TRCODE=71 THEN 'KREDİ KARTI İADE FİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=1 THEN 'ÇEK GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=2 THEN 'SENET GİRİŞİ'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=3 THEN 'ÇEK ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=4 THEN 'SENET ÇIKIŞ (CARİ HESABA)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=5 THEN 'ÇEK ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=6 THEN 'SENET ÇIKIŞ (BANKA TAHSİL)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=7 THEN 'ÇEK ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=8 THEN 'SENET ÇIKIŞ (BANKA TEMİNAT)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=9 THEN 'İŞLEM BORDROSU (MÜŞTERİ ÇEKİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=10 THEN 'İŞLEM BORDROSU (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=11 THEN 'İŞLEM BORDROSU (KENDİ ÇEKİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=12 THEN 'İŞLEM BORDROSU (BORÇ SENEDİMİZ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=13 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=6 AND CSR.TRCODE=14 THEN 'İŞYERLERİ ARASI İ. BORD. (MÜŞTERİ SENEDİ)'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=1	THEN 'BANKA İŞLEM FİŞİ' 
WHEN PAY.MODULENR=7 AND BNT.TRCODE=2 THEN 'BANKA VİRMAN FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=3 THEN 'GELEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=4 THEN 'VERİLEN HAVALE/EFT'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=5 THEN 'BANKA AÇILIŞ FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=6 THEN 'BANKA KUR FARKI FİŞİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=16 THEN 'BANKA ALINAN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=17 THEN 'BANKA VERİLEN HİZMET FATURASI'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=18 THEN 'BANKADAN ÇEK ÖDEMESİ'
WHEN PAY.MODULENR=7 AND BNT.TRCODE=19 THEN 'BANKADAN SENET ÖDEMESİ'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (11) THEN 'KASADAN CARİ HESAP TAHSİLAT'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (12)  THEN 'KASADAN CARİ HESAP ÖDEME'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (21,22)  THEN 'KASADAN BANKA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (31,32,33,34,35,36,37,38,39)  THEN 'KASADAN FATURA'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (61,62,63,64)  THEN 'KASADAN ÇEK/SENET'
WHEN PAY.MODULENR=10 AND KSL.TRCODE IN (71,72,73,74)  THEN 'KASADAN KASA'
WHEN PAY.MODULENR=61 AND PAY.TRCODE=3 THEN 'KARŞILIKSIZ ÇEK/SENET BORÇ DEKONTU' 
ELSE 'DİĞER' END MODÜL,
CASE 
WHEN PAY.MODULENR=4				THEN INV.FICHENO 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.FICHENO
ELSE '' END [FİŞ NO],


CASE 
WHEN PAY.MODULENR=4				THEN INV.DOCODE 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.TRANNO 
WHEN PAY.MODULENR=6				THEN CSC.PORTFOYNO
WHEN PAY.MODULENR=7				THEN BNT.TRANNO 
WHEN PAY.MODULENR=10			THEN KSL.DOCODE
ELSE '' END [BELGE NO],



CASE 
WHEN PAY.MODULENR=4				THEN INV.GENEXP1 
WHEN PAY.MODULENR IN (5,61,62)	THEN CLF.LINEEXP
WHEN PAY.MODULENR=6				THEN 'CEK-SENET GİRİŞİ' 
WHEN PAY.MODULENR=7				THEN BNT.LINEEXP 
WHEN PAY.MODULENR=10			THEN KSL.LINEEXP
ELSE '' END AÇIKLAMA,

CASE WHEN PAY.TRCURR IN (0,160) THEN PAY.TOTAL ELSE 
CASE WHEN PAY.TRRATE>0 THEN 
PAY.TOTAL*PAY.TRRATE ELSE PAY.TOTAL END END [TUTAR],

CASE WHEN PAY.TRCURR IN (0,160) THEN 'TL' ELSE (SELECT CURR.CURCODE FROM L_CURRENCYLIST CURR WHERE CURR.CURTYPE=PAY.TRCURR AND CURR.FIRMNR=23) END [DVZ_TÜRÜ],

PAY.TOTAL DVZ_TUTAR,
DATEPART(MONTH,PAY.DATE_) [DÖNEM],
DATEPART(YEAR,PAY.DATE_) [YIL],
(SELECT EMU.CODE FROM LG_023_EMUHACC EMU,LG_023_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP KODU],
(SELECT EMU.DEFINITION_ FROM LG_023_EMUHACC EMU,LG_023_CRDACREF CRC WHERE EMU.LOGICALREF=CRC.ACCOUNTREF AND CRC.CARDREF=CLC.LOGICALREF AND CRC.TRCODE=5) [MUHASEBE HESAP AÇIKLAMASI]
 FROM 
LG_023_CLCARD CLC							WITH(NOLOCK)  INNER JOIN 
LG_023_01_PAYTRANS PAY						WITH(NOLOCK) ON (PAY.CARDREF=CLC.LOGICALREF)
LEFT OUTER JOIN LG_023_01_INVOICE INV		WITH(NOLOCK) ON (PAY.FICHEREF  =  INV.LOGICALREF)  AND (PAY.MODULENR=4)
LEFT OUTER JOIN LG_023_01_CLFLINE CLF		WITH(NOLOCK) ON (PAY.FICHEREF  =  CLF.LOGICALREF)  AND (PAY.MODULENR IN (5,61,62))
LEFT OUTER JOIN LG_023_01_BNFLINE BNT		WITH(NOLOCK) ON (PAY.FICHEREF  =  BNT.LOGICALREF)  AND  (PAY.MODULENR=7)
LEFT OUTER JOIN LG_023_01_KSLINES KSL		WITH(NOLOCK) ON (PAY.FICHEREF  =  KSL.LOGICALREF) AND (PAY.MODULENR=10) 
LEFT OUTER JOIN LG_023_01_CSROLL CSR		WITH(NOLOCK) ON (PAY.FICHEREF  =  CSR.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_023_01_CSTRANS CST		WITH(NOLOCK) ON (PAY.FICHELINEREF  =  CST.LOGICALREF)   AND  (PAY.MODULENR=6)
LEFT OUTER JOIN LG_023_01_CSCARD  CSC		WITH(NOLOCK) ON (CST.CSREF  =  CSC.LOGICALREF)   AND  (PAY.MODULENR=6)

 WHERE 
PAY.CANCELLED=0 AND PAY.PAID=0 --AND CAST(PAY.DATE_ AS DATE)<CAST(GETDATE() AS DATE)
AND PAY.SIGN=0 
AND PAY.TRCODE NOT IN (3,5,9) 

GO


